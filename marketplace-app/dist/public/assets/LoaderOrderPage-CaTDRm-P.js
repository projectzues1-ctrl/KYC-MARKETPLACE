import{c as Ke,l as ze,b as Qe,d as Ue,u as We,g as Be,r as o,a as P,i as re,j as e,f as m}from"./index-B6hPo9fH.js";import{u as f}from"./useMutation-C_3TpXjp.js";import{B as i}from"./button-DdYfvWb9.js";import{C as n,a as l,b as p,c as h}from"./card-Cl1MO1GN.js";import{B as ie}from"./badge-Dn4EaI7W.js";import{I as we}from"./input-vnQcFn7U.js";import{T as ne}from"./textarea-Cc28xWq-.js";import{S as Je}from"./scroll-area-DqP6ku2v.js";import{D as He,a as Ye,b as Ve,c as Ge,e as Xe}from"./dialog-D_lwzFP4.js";import{L as le}from"./Layout-BTVfT1Q4.js";import{u as Ze}from"./useTranslation-O3_Fa0eH.js";import{L as u}from"./loader-circle-bHqV6n7f.js";import{S as de}from"./shield-DVigj7cn.js";import{C as ke}from"./clock-BbwHj01_.js";import{C as y,T as ce}from"./thumbs-down-DKyiOy3F.js";import{S as $,M as oe}from"./send-DvM8hF-_.js";import{S as Ce}from"./star-CUTTDGaz.js";import{T as me}from"./thumbs-up-CkiQKVSZ.js";import{F as g}from"./flag-CuHtVT3T.js";import{C as ue}from"./circle-x-Cd9ohy9Q.js";import{T as es}from"./triangle-alert-DGpOeCBb.js";import{K as ss}from"./key-round-lLdNQHG2.js";import"./index-Dt-oTuiC.js";import"./index-BdQq_4o_.js";import"./ThemeToggle-Cd9vwdUm.js";import"./shopping-cart-DT7LSJeM.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ts=[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]],as=Ke("arrow-left",ts);function Os(){const{t:rs}=Ze(),[,Se]=ze("/loader-order/:id"),[,xe]=Qe(),r=Se?.id,{toast:d}=Ue(),x=We(),A=Be(),[F,pe]=o.useState(""),[M,I]=o.useState(""),[_e,R]=o.useState(!1),[he,q]=o.useState(!1),[N,be]=o.useState(null),[S,K]=o.useState(""),[fe,ye]=o.useState(!1),[Pe,T]=o.useState(!1),[O,z]=o.useState(""),[je,Q]=o.useState(!1),[U,W]=o.useState(""),[ge,B]=o.useState(!1),[v,L]=o.useState(null),[Ne,J]=o.useState(""),{data:t,isLoading:Fe}=P({queryKey:["loaderOrder",r],queryFn:async()=>{const s=await m(`/api/loaders/orders/${r}`);if(!s.ok)throw new Error("Order not found");return s.json()},enabled:!!r&&re(),refetchInterval:5e3}),{data:D,refetch:j}=P({queryKey:["loaderOrderMessages",r],queryFn:async()=>{const s=await m(`/api/loaders/orders/${r}/messages`),a=await s.json();return!s.ok||!Array.isArray(a)?[]:a},enabled:!!r&&re(),refetchInterval:5e3}),{data:ve}=P({queryKey:["loaderDispute",r],queryFn:async()=>{const s=await m(`/api/loaders/orders/${r}/dispute`);return s.ok?s.json():null},enabled:!!r&&t?.status==="disputed"}),{data:Te}=P({queryKey:["userProfile"],queryFn:async()=>(await m("/api/auth/me")).json(),enabled:re()}),{data:b,refetch:Oe}=P({queryKey:["loaderOrderFeedback",r],queryFn:async()=>{const s=await m(`/api/loaders/orders/${r}/feedback`);return s.ok?s.json():{feedback:[],hasLeftFeedback:!1,userFeedback:null}},enabled:!!r&&t?.status==="completed"}),H=f({mutationFn:async()=>{const s=await m(`/api/loaders/orders/${r}/feedback`,{method:"POST",body:JSON.stringify({feedbackType:v,comment:Ne})});if(!s.ok){const a=await s.json();throw new Error(a.message)}return s.json()},onSuccess:()=>{d({title:"Feedback Submitted",description:"Thank you for your feedback!"}),B(!1),L(null),J(""),Oe(),x.invalidateQueries({queryKey:["loaderOrderFeedback",r]})},onError:s=>{d({variant:"destructive",title:"Error",description:s.message})}}),Y=["completed","closed_no_payment","cancelled_auto","cancelled_loader","cancelled_receiver","disputed","resolved_loader_wins","resolved_receiver_wins","resolved_mutual"],Le=["completed","cancelled_auto","cancelled_loader","cancelled_receiver"];o.useEffect(()=>{if(!t?.countdownExpiresAt||t.countdownStopped||Y.includes(t?.status||"")){be(null);return}const s=()=>{const c=new Date(t.countdownExpiresAt).getTime(),ae=Date.now(),qe=Math.max(0,Math.floor((c-ae)/1e3));be(qe)};s();const a=setInterval(s,1e3);return()=>clearInterval(a)},[t?.countdownExpiresAt,t?.countdownStopped,t?.status]);const V=f({mutationFn:async()=>{const s=await m(`/api/loaders/orders/${r}/send-payment-details`,{method:"POST"});if(!s.ok){const a=await s.json();throw new Error(a.message)}return s.json()},onSuccess:()=>{d({title:"Success",description:"Payment details sent. Countdown stopped."}),x.invalidateQueries({queryKey:["loaderOrder",r]}),j()},onError:s=>{d({variant:"destructive",title:"Error",description:s.message})}}),G=f({mutationFn:async()=>{const s=await m(`/api/loaders/orders/${r}/mark-payment-sent`,{method:"POST"});if(!s.ok){const a=await s.json();throw new Error(a.message)}return s.json()},onSuccess:()=>{d({title:"Success",description:"Payment marked as sent."}),x.invalidateQueries({queryKey:["loaderOrder",r]}),j()},onError:s=>{d({variant:"destructive",title:"Error",description:s.message})}}),w=f({mutationFn:async s=>{const a=await m(`/api/loaders/orders/${r}/complete`,{method:"POST",body:JSON.stringify({twoFactorCode:s})});if(!a.ok){const c=await a.json();throw new Error(c.message)}return a.json()},onSuccess:()=>{d({title:"Success",description:"Order completed! Fees deducted and funds released."}),x.invalidateQueries({queryKey:["loaderOrder",r]}),x.invalidateQueries({queryKey:["wallet"]}),j(),T(!1),z("")},onError:s=>{d({variant:"destructive",title:"Error",description:s.message})}}),X=f({mutationFn:async()=>{const s=await m(`/api/loaders/orders/${r}/dispute`,{method:"POST",body:JSON.stringify({reason:U})});if(!s.ok){const a=await s.json();throw new Error(a.message)}return s.json()},onSuccess:()=>{d({title:"Dispute Opened",description:"Admin will review and resolve your dispute."}),x.invalidateQueries({queryKey:["loaderOrder",r]}),j(),Q(!1),W("")},onError:s=>{d({variant:"destructive",title:"Error",description:s.message})}}),De=()=>{Te?.twoFactorEnabled?T(!0):w.mutate(void 0)},Ee=()=>{if(!O){d({variant:"destructive",title:"Error",description:"Please enter your 2FA code"});return}w.mutate(O)},Z=f({mutationFn:async()=>{const s=await m(`/api/loaders/orders/${r}/cancel`,{method:"POST"});if(!s.ok){const a=await s.json();throw new Error(a.message)}return s.json()},onSuccess:()=>{d({title:"Order Cancelled",description:"5% penalty has been deducted."}),x.invalidateQueries({queryKey:["loaderOrder",r]}),x.invalidateQueries({queryKey:["wallet"]}),j(),q(!1)},onError:s=>{d({variant:"destructive",title:"Error",description:s.message})}}),ee=f({mutationFn:async()=>{const s=await m(`/api/loaders/orders/${r}/dispute`,{method:"POST",body:JSON.stringify({reason:M})});if(!s.ok){const a=await s.json();throw new Error(a.message)}return s.json()},onSuccess:()=>{d({title:"Dispute Opened",description:"Admin will review and resolve."}),x.invalidateQueries({queryKey:["loaderOrder",r]}),j(),R(!1),I("")},onError:s=>{d({variant:"destructive",title:"Error",description:s.message})}}),E=f({mutationFn:async()=>{const s=await m(`/api/loaders/orders/${r}/messages`,{method:"POST",body:JSON.stringify({content:F})});if(!s.ok)throw new Error("Failed to send message");return s.json()},onSuccess:()=>{pe(""),j()}}),se=f({mutationFn:async s=>{const a=await m(`/api/loaders/orders/${r}/select-liability`,{method:"POST",body:JSON.stringify({liabilityType:s})});if(!a.ok){const c=await a.json();throw new Error(c.message)}return a.json()},onSuccess:()=>{d({title:"Liability Terms Selected",description:"Both parties must now confirm the agreement."}),x.invalidateQueries({queryKey:["loaderOrder",r]}),j()},onError:s=>{d({variant:"destructive",title:"Error",description:s.message})}}),te=f({mutationFn:async()=>{const s=await m(`/api/loaders/orders/${r}/confirm-liability`,{method:"POST"});if(!s.ok){const a=await s.json();throw new Error(a.message)}return s.json()},onSuccess:s=>{s.locked?d({title:"Agreement Locked!",description:"Order proceeding to payment phase."}):d({title:"Confirmed",description:"Waiting for other party to confirm."}),x.invalidateQueries({queryKey:["loaderOrder",r]}),j(),ye(!1)},onError:s=>{d({variant:"destructive",title:"Error",description:s.message})}}),k=t?.receiverId===A?.id,C=t?.loaderId===A?.id,$e=s=>{const a=Math.floor(s/60),c=s%60;return`${a}:${c.toString().padStart(2,"0")}`},Ae=s=>{const c={awaiting_liability_confirmation:{label:"Select Liability Terms",variant:"outline"},awaiting_payment_details:{label:"Awaiting Details",variant:"outline"},payment_details_sent:{label:"Details Sent",variant:"default"},payment_sent:{label:"Payment Sent",variant:"default"},asset_frozen_waiting:{label:"Asset Frozen - Waiting",variant:"secondary"},completed:{label:"Completed",variant:"default"},closed_no_payment:{label:"Closed - No Payment",variant:"secondary"},cancelled_auto:{label:"Auto-Cancelled",variant:"secondary"},cancelled_loader:{label:"Cancelled by Loader",variant:"destructive"},cancelled_receiver:{label:"Cancelled by Receiver",variant:"destructive"},disputed:{label:"Disputed",variant:"destructive"},resolved_loader_wins:{label:"Resolved - Loader Wins",variant:"default"},resolved_receiver_wins:{label:"Resolved - Receiver Wins",variant:"default"},resolved_mutual:{label:"Resolved - Mutual",variant:"secondary"}}[s]||{label:s.replace(/_/g," "),variant:"secondary"};return e.jsx(ie,{variant:c.variant,children:c.label})},_=parseFloat(t?.dealAmount||"0"),Me=_*.05,Ie=t&&!Y.includes(t.status)&&!(k&&t.loaderMarkedPaymentSent),Re=t&&["payment_details_sent","payment_sent"].includes(t.status);return t&&Y.includes(t.status),Fe?e.jsx(le,{children:e.jsx("div",{className:"flex justify-center items-center py-20",children:e.jsx(u,{className:"h-8 w-8 animate-spin"})})}):t?e.jsxs(le,{children:[e.jsxs("div",{className:"max-w-2xl mx-auto pb-24",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[e.jsx(i,{variant:"ghost",size:"icon",onClick:()=>xe("/"),"data-testid":"button-back",children:e.jsx(as,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h1",{className:"text-xl font-bold flex items-center gap-2","data-testid":"text-order-title",children:[e.jsx(de,{className:"h-5 w-5 text-primary"}),"Loader Order"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Order #",t.id.slice(0,8)]})]}),Ae(t.status)]}),N!==null&&N>0&&!t.countdownStopped&&e.jsx(n,{className:`mb-4 ${N<60?"border-destructive/50 bg-destructive/5":"border-amber-500/50 bg-amber-500/5"}`,children:e.jsxs(l,{className:"py-4 text-center",children:[e.jsx(ke,{className:`h-8 w-8 mx-auto mb-2 ${N<60?"text-destructive":"text-amber-600"}`}),e.jsx("p",{className:`text-2xl font-bold ${N<60?"text-destructive":"text-amber-600"}`,children:$e(N)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Time remaining to send payment details"})]})}),t.countdownStopped&&t.status==="payment_details_sent"&&e.jsx(n,{className:"mb-4 border-green-500/50 bg-green-500/5",children:e.jsxs(l,{className:"py-4 text-center",children:[e.jsx(y,{className:"h-8 w-8 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"font-semibold text-green-600",children:"Payment Details Exchanged"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Countdown stopped. Proceed with the transaction."})]})}),t.status==="awaiting_liability_confirmation"&&e.jsxs(n,{className:"mb-4 border-amber-500/50 bg-amber-500/5",children:[e.jsx(p,{className:"pb-2",children:e.jsxs(h,{className:"text-base flex items-center gap-2",children:[e.jsx(de,{className:"h-5 w-5 text-amber-600"}),"Liability Terms Selection"]})}),e.jsxs(l,{className:"space-y-4",children:[e.jsx("div",{className:"p-3 bg-amber-100 dark:bg-amber-900/30 rounded-lg text-sm",children:e.jsx("p",{className:"font-medium text-amber-800 dark:text-amber-200",children:"Receiver must select liability terms before funds are sent."})}),k&&!t.liabilityLockedAt&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-start gap-3 p-3 border rounded-lg cursor-pointer hover:bg-muted/50 transition-colors",children:[e.jsx("input",{type:"radio",name:"liability",value:"full_payment",checked:S==="full_payment"||t.liabilityType==="full_payment",onChange:s=>K(s.target.value),className:"mt-1",disabled:!!t.liabilityType,"data-testid":"radio-full-payment"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Option 1 — Full Payment"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"I will pay the full deal amount even if the assets are frozen, delayed, or unusable."})]})]}),e.jsxs("div",{className:"border rounded-lg p-3",children:[e.jsx("p",{className:"font-medium mb-2",children:"Option 2 — Partial Payment"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"If the assets are frozen or unusable, I agree to pay a percentage of the deal amount."}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:["partial_10","partial_25","partial_50"].map(s=>e.jsxs("label",{className:"flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-muted/50",children:[e.jsx("input",{type:"radio",name:"liability",value:s,checked:S===s||t.liabilityType===s,onChange:a=>K(a.target.value),disabled:!!t.liabilityType,"data-testid":`radio-${s}`}),e.jsxs("span",{children:[s.split("_")[1],"%"]})]},s))})]}),e.jsxs("div",{className:"border rounded-lg p-3",children:[e.jsx("p",{className:"font-medium mb-2",children:"Option 3 — Time-Bound Temporary Freeze"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"If assets are temporarily frozen, I agree to wait. If assets are usable before the deadline, I will pay in full. If still frozen at deadline, the deal closes with no payment."}),e.jsx("div",{className:"flex gap-2 flex-wrap",children:[{val:"time_bound_24h",label:"24 hours"},{val:"time_bound_48h",label:"48 hours"},{val:"time_bound_72h",label:"72 hours"},{val:"time_bound_1week",label:"1 week"},{val:"time_bound_1month",label:"1 month"}].map(({val:s,label:a})=>e.jsxs("label",{className:"flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-muted/50",children:[e.jsx("input",{type:"radio",name:"liability",value:s,checked:S===s||t.liabilityType===s,onChange:c=>K(c.target.value),disabled:!!t.liabilityType,"data-testid":`radio-${s}`}),e.jsx("span",{children:a})]},s))})]})]}),!t.liabilityType&&S&&e.jsxs(i,{className:"w-full",onClick:()=>se.mutate(S),disabled:se.isPending,"data-testid":"button-select-liability",children:[se.isPending?e.jsx(u,{className:"h-4 w-4 animate-spin mr-2"}):null,"Confirm Liability Selection"]})]}),t.liabilityType&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 bg-muted rounded-lg",children:[e.jsx("p",{className:"text-sm font-medium",children:"Selected Liability Terms:"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[t.liabilityType==="full_payment"&&"Full Payment - Pay full amount even if assets are frozen",t.liabilityType?.startsWith("partial_")&&`Partial Payment - ${t.liabilityType.split("_")[1]}% if assets are frozen`,t.liabilityType?.startsWith("time_bound_")&&(()=>{const s=t.liabilityType==="time_bound_24h"?"24 hours":t.liabilityType==="time_bound_48h"?"48 hours":t.liabilityType==="time_bound_72h"?"72 hours":t.liabilityType==="time_bound_1week"?"1 week":t.liabilityType==="time_bound_1month"?"1 month":"unknown";return`Time-Bound (${s}) - If assets are temporarily frozen, receiver agrees to wait ${s}. If assets are usable before the deadline, full payment applies. If still frozen at deadline, the deal closes with no payment.`})()]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(y,{className:`h-5 w-5 ${t.receiverLiabilityConfirmed?"text-green-600":"text-muted-foreground"}`}),e.jsxs("span",{className:t.receiverLiabilityConfirmed?"text-green-600":"",children:["Receiver ",t.receiverLiabilityConfirmed?"Confirmed":"Pending"]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(y,{className:`h-5 w-5 ${t.loaderLiabilityConfirmed?"text-green-600":"text-muted-foreground"}`}),e.jsxs("span",{className:t.loaderLiabilityConfirmed?"text-green-600":"",children:["Loader ",t.loaderLiabilityConfirmed?"Confirmed":"Pending"]})]})]}),(k&&!t.receiverLiabilityConfirmed||C&&!t.loaderLiabilityConfirmed)&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"flex items-start gap-3 p-3 border border-destructive/50 rounded-lg",children:[e.jsx("input",{type:"checkbox",checked:fe,onChange:s=>ye(s.target.checked),className:"mt-1","data-testid":"checkbox-liability-confirm"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-destructive",children:"Mandatory Confirmation"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"I understand this decision is final and cannot be changed later."})]})]}),e.jsxs(i,{className:"w-full",onClick:()=>te.mutate(),disabled:!fe||te.isPending,"data-testid":"button-confirm-liability",children:[te.isPending?e.jsx(u,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(y,{className:"h-4 w-4 mr-2"}),"I Agree - Confirm Liability Terms"]})]})]}),C&&!t.liabilityType&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-3 bg-muted rounded-lg text-center",children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Waiting for receiver to select liability terms..."})}),e.jsxs("div",{className:"border rounded-lg p-4 bg-muted/30",children:[e.jsx("p",{className:"font-medium mb-3 text-sm",children:"Liability Options Reference:"}),e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"border-b pb-2",children:[e.jsx("p",{className:"font-medium",children:"Full Payment"}),e.jsx("p",{className:"text-muted-foreground",children:"Receiver pays full amount even if assets are frozen or unusable."})]}),e.jsxs("div",{className:"border-b pb-2",children:[e.jsx("p",{className:"font-medium",children:"Partial Payment (10%, 25%, or 50%)"}),e.jsx("p",{className:"text-muted-foreground",children:"Receiver pays a percentage of the deal if assets are frozen or unusable."})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Time-Bound (24h, 48h, 72h, 1 week, 1 month)"}),e.jsx("p",{className:"text-muted-foreground",children:"If assets are temporarily frozen, receiver waits until deadline. If usable before deadline, full payment applies. If still frozen at deadline, deal closes with no payment owed."})]})]})]})]})]})]}),e.jsxs(n,{className:"mb-4",children:[e.jsx(p,{className:"pb-2",children:e.jsx(h,{className:"text-base",children:"Deal Details"})}),e.jsx(l,{className:"space-y-2",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Asset Type"}),e.jsx("p",{className:"font-medium",children:t.ad?.assetType||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Deal Amount"}),e.jsxs("p",{className:"font-medium",children:["$",_.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Loader"}),e.jsx("p",{className:"font-medium",children:t.loaderUsername})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Receiver"}),e.jsx("p",{className:"font-medium",children:t.receiverUsername})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Loader Fee"}),e.jsxs("p",{className:"font-medium",children:["3% ($",(_*.03).toFixed(2),")"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Receiver Fee"}),e.jsxs("p",{className:"font-medium",children:["2% ($",(_*.02).toFixed(2),")"]})]})]})})]}),t.status==="awaiting_payment_details"&&k&&e.jsxs(n,{className:"mb-4 border-primary/50",children:[e.jsx(p,{className:"pb-2",children:e.jsxs(h,{className:"text-base flex items-center gap-2",children:[e.jsx($,{className:"h-5 w-5 text-primary"}),"Send Payment Details"]})}),e.jsxs(l,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Send your payment details to the loader in the chat below. Once done, click the button to confirm."}),e.jsxs(i,{className:"w-full",onClick:()=>V.mutate(),disabled:V.isPending,"data-testid":"button-send-payment-details",children:[V.isPending?e.jsx(u,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx($,{className:"h-4 w-4 mr-2"}),"I've Sent Payment Details in Chat"]})]})]}),t.status==="awaiting_payment_details"&&C&&e.jsx(n,{className:"mb-4 border-amber-500/50 bg-amber-500/5",children:e.jsxs(l,{className:"py-4 text-center",children:[e.jsx(ke,{className:"h-8 w-8 text-amber-600 mx-auto mb-2"}),e.jsx("p",{className:"font-semibold text-amber-600",children:"Waiting for Receiver"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"The receiver needs to send their payment details before the countdown expires."})]})}),t.status==="payment_details_sent"&&C&&!t.loaderMarkedPaymentSent&&e.jsxs(n,{className:"mb-4 border-primary/50",children:[e.jsx(p,{className:"pb-2",children:e.jsxs(h,{className:"text-base flex items-center gap-2",children:[e.jsx(y,{className:"h-5 w-5 text-primary"}),"Mark Payment Sent"]})}),e.jsxs(l,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Once you've sent the payment to the receiver, click below to notify them."}),e.jsxs(i,{className:"w-full",onClick:()=>G.mutate(),disabled:G.isPending,"data-testid":"button-mark-payment-sent",children:[G.isPending?e.jsx(u,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(y,{className:"h-4 w-4 mr-2"}),"I've Sent the Payment"]})]})]}),(t.status==="payment_sent"||t.status==="payment_details_sent"&&t.loaderMarkedPaymentSent)&&k&&e.jsxs(n,{className:"mb-4 border-green-500/50",children:[e.jsx(p,{className:"pb-2",children:e.jsxs(h,{className:"text-base flex items-center gap-2 text-green-600",children:[e.jsx(y,{className:"h-5 w-5"}),"Confirm Payment Received"]})}),e.jsxs(l,{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Once you've received the payment and verified it, click below to complete the order. Your 2% fee ($",(_*.02).toFixed(2),") will be deducted."]}),e.jsxs(i,{className:"w-full bg-green-600 hover:bg-green-700",onClick:De,disabled:w.isPending,"data-testid":"button-complete",children:[w.isPending?e.jsx(u,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(y,{className:"h-4 w-4 mr-2"}),"Confirm Payment Received - Complete Order"]})]})]}),t.status==="completed"&&e.jsx(n,{className:"mb-4 border-green-500/50 bg-green-500/5",children:e.jsxs(l,{className:"py-6 text-center",children:[e.jsx(y,{className:"h-12 w-12 text-green-600 mx-auto mb-2"}),e.jsx("p",{className:"font-semibold text-green-600",children:"Order Completed"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Fees deducted and funds released successfully."})]})}),(t.status==="completed"||t.status==="resolved_loader_wins"&&C||t.status==="resolved_receiver_wins"&&k||t.status==="resolved_mutual")&&!b?.hasLeftFeedback&&!ge&&e.jsx(n,{className:"mb-4 border-primary/50",children:e.jsxs(l,{className:"py-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"How was your experience with this order? Leave feedback to help other users."}),e.jsxs(i,{className:"w-full",onClick:()=>B(!0),"data-testid":"button-leave-feedback",children:[e.jsx(Ce,{className:"h-4 w-4 mr-2"}),"Leave Feedback"]})]})}),ge&&e.jsxs(n,{className:"mb-4 border-primary/50",children:[e.jsx(p,{className:"pb-2",children:e.jsxs(h,{className:"text-base flex items-center gap-2",children:[e.jsx(Ce,{className:"h-5 w-5 text-primary"}),"Leave Feedback"]})}),e.jsxs(l,{className:"space-y-4",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Rate your experience with ",C?t.receiverUsername:t.loaderUsername]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(i,{variant:v==="positive"?"default":"outline",className:`flex-1 ${v==="positive"?"bg-green-600 hover:bg-green-700":""}`,onClick:()=>L("positive"),"data-testid":"button-positive-feedback",children:[e.jsx(me,{className:"h-4 w-4 mr-2"}),"Positive"]}),e.jsxs(i,{variant:v==="negative"?"default":"outline",className:`flex-1 ${v==="negative"?"bg-destructive hover:bg-destructive/90":""}`,onClick:()=>L("negative"),"data-testid":"button-negative-feedback",children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Negative"]})]}),e.jsx(ne,{value:Ne,onChange:s=>J(s.target.value),placeholder:"Add a comment (optional)...","data-testid":"input-feedback-comment"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(i,{className:"flex-1",onClick:()=>H.mutate(),disabled:!v||H.isPending,"data-testid":"button-submit-feedback",children:[H.isPending?e.jsx(u,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx($,{className:"h-4 w-4 mr-2"}),"Submit Feedback"]}),e.jsx(i,{variant:"outline",className:"flex-1",onClick:()=>{B(!1),L(null),J("")},"data-testid":"button-cancel-feedback",children:"Cancel"})]})]})]}),b?.hasLeftFeedback&&b.userFeedback&&e.jsx(n,{className:"mb-4 border-green-500/50 bg-green-500/5",children:e.jsxs(l,{className:"py-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[b.userFeedback.feedbackType==="positive"?e.jsx(me,{className:"h-5 w-5 text-green-600"}):e.jsx(ce,{className:"h-5 w-5 text-destructive"}),e.jsxs("p",{className:"font-medium",children:["You left ",b.userFeedback.feedbackType," feedback"]})]}),b.userFeedback.comment&&e.jsx("p",{className:"text-sm text-muted-foreground",children:b.userFeedback.comment})]})}),b?.feedback&&b.feedback.length>0&&e.jsxs(n,{className:"mb-4",children:[e.jsx(p,{className:"pb-2",children:e.jsxs(h,{className:"text-base flex items-center gap-2",children:[e.jsx(oe,{className:"h-5 w-5"}),"Feedback on this Order"]})}),e.jsx(l,{className:"space-y-3",children:b.feedback.map(s=>e.jsxs("div",{className:"p-3 bg-muted rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[s.feedbackType==="positive"?e.jsx(me,{className:"h-4 w-4 text-green-600"}):e.jsx(ce,{className:"h-4 w-4 text-destructive"}),e.jsx("span",{className:"text-sm font-medium",children:s.giverUsername}),e.jsx("span",{className:"text-xs text-muted-foreground ml-auto",children:new Date(s.createdAt).toLocaleDateString()})]}),s.comment&&e.jsx("p",{className:"text-sm text-muted-foreground",children:s.comment})]},s.id))})]}),Le.includes(t.status)&&!je&&e.jsx(n,{className:"mb-4 border-amber-500/50",children:e.jsxs(l,{className:"py-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:"If you believe there was an issue with this order, you can raise a dispute within 72 hours."}),e.jsxs(i,{variant:"outline",className:"w-full border-amber-500 text-amber-600 hover:bg-amber-500/10",onClick:()=>Q(!0),"data-testid":"button-raise-dispute",children:[e.jsx(g,{className:"h-4 w-4 mr-2"}),"Raise Dispute"]})]})}),je&&e.jsxs(n,{className:"mb-4 border-amber-500/50",children:[e.jsx(p,{className:"pb-2",children:e.jsxs(h,{className:"text-base flex items-center gap-2 text-amber-600",children:[e.jsx(g,{className:"h-5 w-5"}),"Raise Dispute"]})}),e.jsxs(l,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Explain why you're disputing this order. Admin will review and the losing party may pay a penalty."}),e.jsx(ne,{value:U,onChange:s=>W(s.target.value),placeholder:"Describe the issue...","data-testid":"input-post-dispute-reason"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(i,{className:"flex-1",onClick:()=>X.mutate(),disabled:!U||X.isPending,"data-testid":"button-submit-post-dispute",children:[X.isPending?e.jsx(u,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(g,{className:"h-4 w-4 mr-2"}),"Submit Dispute"]}),e.jsx(i,{variant:"outline",className:"flex-1",onClick:()=>{Q(!1),W("")},"data-testid":"button-cancel-post-dispute",children:"Cancel"})]})]})]}),t.status==="disputed"&&e.jsx(n,{className:"mb-4 border-destructive/50 bg-destructive/5",children:e.jsxs(l,{className:"py-6 text-center",children:[e.jsx(g,{className:"h-12 w-12 text-destructive mx-auto mb-2"}),e.jsx("p",{className:"font-semibold text-destructive",children:"Order Disputed"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Admin is reviewing. The losing party will pay a 5% penalty."}),ve&&e.jsxs("div",{className:"mt-4 text-left p-3 bg-muted rounded-lg",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Reason:"}),e.jsx("p",{className:"text-sm",children:ve.reason})]})]})}),(t.status.startsWith("cancelled_")||t.status.startsWith("resolved_"))&&e.jsx(n,{className:"mb-4 border-muted bg-muted/20",children:e.jsxs(l,{className:"py-6 text-center",children:[e.jsx(ue,{className:"h-12 w-12 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"font-semibold text-muted-foreground",children:t.status.replace(/_/g," ").replace(/^\w/,s=>s.toUpperCase())}),t.penaltyAmount&&parseFloat(t.penaltyAmount)>0&&e.jsxs("p",{className:"text-sm text-destructive mt-2",children:["5% penalty ($",parseFloat(t.penaltyAmount).toFixed(2),") was applied."]})]})}),Ie&&!he&&e.jsx(n,{className:"mb-4",children:e.jsxs(l,{className:"py-4 flex gap-3",children:[e.jsxs(i,{variant:"destructive",className:"flex-1",onClick:()=>q(!0),"data-testid":"button-cancel-order",children:[e.jsx(ue,{className:"h-4 w-4 mr-2"}),"Cancel Order"]}),Re&&e.jsxs(i,{variant:"outline",className:"flex-1",onClick:()=>R(!0),"data-testid":"button-open-dispute",children:[e.jsx(g,{className:"h-4 w-4 mr-2"}),"Open Dispute"]})]})}),he&&e.jsxs(n,{className:"mb-4 border-destructive/50",children:[e.jsx(p,{className:"pb-2",children:e.jsxs(h,{className:"text-base flex items-center gap-2 text-destructive",children:[e.jsx(es,{className:"h-5 w-5"}),"Confirm Cancellation"]})}),e.jsxs(l,{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 bg-destructive/10 rounded-lg",children:[e.jsxs("p",{className:"text-sm text-destructive font-medium",children:["Warning: You will be charged a 5% penalty ($",Me.toFixed(2),") for cancelling."]}),e.jsx("p",{className:"text-xs text-destructive mt-1",children:"The other party will receive a full refund."})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(i,{variant:"destructive",className:"flex-1",onClick:()=>Z.mutate(),disabled:Z.isPending,"data-testid":"button-confirm-cancel",children:[Z.isPending?e.jsx(u,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(ue,{className:"h-4 w-4 mr-2"}),"Yes, Cancel and Pay Penalty"]}),e.jsx(i,{variant:"outline",className:"flex-1",onClick:()=>q(!1),"data-testid":"button-nevermind",children:"Never Mind"})]})]})]}),_e&&e.jsxs(n,{className:"mb-4 border-amber-500/50",children:[e.jsx(p,{className:"pb-2",children:e.jsxs(h,{className:"text-base flex items-center gap-2 text-amber-600",children:[e.jsx(g,{className:"h-5 w-5"}),"Open Dispute"]})}),e.jsxs(l,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Explain why you're opening a dispute. Admin will review and the losing party will pay a 5% penalty."}),e.jsx(ne,{value:M,onChange:s=>I(s.target.value),placeholder:"Describe the issue...","data-testid":"input-dispute-reason"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(i,{className:"flex-1",onClick:()=>ee.mutate(),disabled:!M||ee.isPending,"data-testid":"button-submit-dispute",children:[ee.isPending?e.jsx(u,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(g,{className:"h-4 w-4 mr-2"}),"Submit Dispute"]}),e.jsx(i,{variant:"outline",className:"flex-1",onClick:()=>{R(!1),I("")},"data-testid":"button-cancel-dispute",children:"Cancel"})]})]})]}),e.jsxs(n,{className:"border-2",children:[e.jsx(p,{className:"pb-3 border-b bg-muted/30",children:e.jsxs(h,{className:"text-base flex items-center gap-2",children:[e.jsx(oe,{className:"h-5 w-5 text-primary"}),"Order Chat",e.jsxs(ie,{variant:"outline",className:"ml-auto text-xs",children:[D?.length||0," messages"]})]})}),e.jsxs(l,{className:"p-0",children:[e.jsx(Je,{className:"h-80 p-4",children:e.jsxs("div",{className:"space-y-4",children:[D?.map(s=>{const a=s.senderId===A?.id,c=s.senderId===t?.loaderId,ae=s.senderId===t?.receiverId;return s.isSystem?e.jsx("div",{className:"flex justify-center my-3",children:e.jsxs("div",{className:`inline-flex items-center gap-2 px-4 py-2 rounded-full text-xs font-medium ${s.isAdminMessage?"bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-300 border border-amber-300 dark:border-amber-700":"bg-muted text-muted-foreground"}`,children:[s.isAdminMessage&&e.jsx(de,{className:"h-3 w-3"}),s.content]})},s.id):e.jsxs("div",{className:`flex items-end gap-2 ${a?"flex-row-reverse":"flex-row"}`,children:[e.jsx("div",{className:`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${c?"bg-blue-500 text-white":ae?"bg-green-500 text-white":"bg-gray-500 text-white"}`,children:s.senderUsername?.slice(0,2).toUpperCase()||"??"}),e.jsxs("div",{className:`max-w-[75%] ${a?"items-end":"items-start"}`,children:[e.jsxs("div",{className:`flex items-center gap-2 mb-1 ${a?"flex-row-reverse":"flex-row"}`,children:[e.jsx("span",{className:`text-xs font-semibold ${c?"text-blue-600 dark:text-blue-400":"text-green-600 dark:text-green-400"}`,children:s.senderUsername}),e.jsx(ie,{variant:"outline",className:"text-[10px] px-1.5 py-0",children:c?"Loader":"Receiver"})]}),e.jsx("div",{className:`px-4 py-2.5 rounded-2xl shadow-sm ${a?"bg-primary text-primary-foreground rounded-br-md":"bg-muted border rounded-bl-md"}`,children:e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:s.content})}),e.jsx("p",{className:`text-[10px] text-muted-foreground mt-1 ${a?"text-right":"text-left"}`,children:new Date(s.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})]},s.id)}),(!D||D.length===0)&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 text-muted-foreground",children:[e.jsx(oe,{className:"h-12 w-12 mb-3 opacity-30"}),e.jsx("p",{className:"text-sm font-medium",children:"No messages yet"}),e.jsx("p",{className:"text-xs",children:"Start the conversation below"})]})]})}),e.jsx("div",{className:"p-4 border-t bg-muted/20",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(we,{value:F,onChange:s=>pe(s.target.value),placeholder:"Type your message...",className:"flex-1",onKeyDown:s=>s.key==="Enter"&&!s.shiftKey&&F&&E.mutate(),"data-testid":"input-message"}),e.jsx(i,{onClick:()=>E.mutate(),disabled:!F||E.isPending,className:"px-4","data-testid":"button-send",children:E.isPending?e.jsx(u,{className:"h-4 w-4 animate-spin"}):e.jsx($,{className:"h-4 w-4"})})]})})]})]})]}),e.jsx(He,{open:Pe,onOpenChange:T,children:e.jsxs(Ye,{children:[e.jsxs(Ve,{children:[e.jsxs(Ge,{className:"flex items-center gap-2",children:[e.jsx(ss,{className:"h-5 w-5 text-primary"}),"2FA Verification Required"]}),e.jsx(Xe,{children:"Please enter your authenticator code to confirm payment and complete the order."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{children:e.jsx(we,{type:"text",placeholder:"Enter 6-digit code",value:O,onChange:s=>z(s.target.value.replace(/\D/g,"").slice(0,6)),maxLength:6,className:"text-center text-lg tracking-widest","data-testid":"input-2fa-code"})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(i,{className:"flex-1 bg-green-600 hover:bg-green-700",onClick:Ee,disabled:O.length!==6||w.isPending,"data-testid":"button-verify-2fa",children:[w.isPending?e.jsx(u,{className:"h-4 w-4 animate-spin mr-2"}):e.jsx(y,{className:"h-4 w-4 mr-2"}),"Verify & Complete"]}),e.jsx(i,{variant:"outline",onClick:()=>{T(!1),z("")},"data-testid":"button-cancel-2fa",children:"Cancel"})]})]})]})})]}):e.jsx(le,{children:e.jsxs("div",{className:"text-center py-20",children:[e.jsx("p",{className:"text-muted-foreground",children:"Order not found"}),e.jsx(i,{variant:"outline",className:"mt-4",onClick:()=>xe("/"),"data-testid":"button-go-home",children:"Go Home"})]})})}export{Os as default};
